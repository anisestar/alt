name: release

on:
  push:
    branches: [main]
    tags:
      - "*"
jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v2
        with:
          fetch-depth: 0
      - name: Set up Go
        uses: actions/setup-go@v2
        with:
          go-version: 1.17
      - name: Build Alt
        run: |
          GOOS=darwin GOARCH=x86_64 go build -o alt-darwin-x86_64 .
          GOOS=darwin GOARCH=aarch64 go build -o alt-darwin-aarch64 .
          GOOS=linux GOARCH=x86_64 go build -o alt-linux-x86_64 .
          GOOS=linux GOARCH=aarch64 go build -o alt-linux-aarch .
      - name: Package Alt
        run: |
          mkdir darwin-x86_64 darwin-aarch64 linux-x86_64 linux-aarch
          cp package.toml darwin-x86_64
          mv alt-darwin-x86_64 darwin-x86_64/alt
          cp package.toml darwin-aarch64
          mv alt-darwin-aarch64 darwin-aarch64/alt
          cp package.toml linux-x86_64
          mv alt-linux-x86_64 linux-x86_64/alt
          cp package.toml linux-aarch64
          mv alt-linux-aarch64 linux-aarch64/alt
          (cd darwin-x86_64 && tar cfJ ../darwin-x86_64.apkg *)
          (cd darwin-aarch64 && tar cfJ ../darwin-aarch64.apkg *)
          (cd linux-x86_64 && tar cfJ ../linux-x86_64.apkg *)
          (cd linux-aarch64 && tar cfJ ../linux-aarch64.apkg *)
      - name: Release Alt
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/v')
        with:
          files: |
            darwin-x86_64.apkg
            darwin-aarch64.apkg
            linux-x86_64.apkg
            linux-aarch64.apkg
